<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gesti√≥n de Premios - DH2OCOL</title>
    <link rel="stylesheet" href="/assets/css/premios.css" />
    <link rel="icon" href="/assets/img/logo_4.png" type="image/png" />
    <link rel="shortcut icon" href="/assets/img/logo_4.png" type="image/png" />
    <link rel="apple-touch-icon" href="/assets/img/logo_4.png" />
    <meta name="theme-color" content="#1986c8" />
    <meta name="msapplication-TileColor" content="#008037" />
  </head>
  <body>
    <div class="header">
      <h1>üéÅ Gesti√≥n de Premios - DH2OCOL</h1>
      <div class="nav-buttons">
        <button class="btn" onclick="window.location.href='/admin'">
          üë®‚Äçüíº Volver al Panel
        </button>
      </div>
    </div>

    <div class="container">
      <div class="controls">
        <div class="search-box">
          <input type="text" id="search" placeholder="Buscar premios..." />
        </div>
        <button class="btn btn-success" onclick="abrirModalCrear()">
          ‚ûï Nuevo Premio
        </button>
        <button class="btn" onclick="cargarPremios()">üîÑ Actualizar</button>
      </div>

      <div class="table-container">
        <div id="loading" class="loading">Cargando premios...</div>

        <table id="premios-table" style="display: none">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Descripci√≥n</th>
              <th>Cantidad Disponible</th>
              <th>Estado</th>
              <th>Fecha Creaci√≥n</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="premios-tbody"></tbody>
        </table>

        <div id="empty-state" class="empty-state" style="display: none">
          <p>No hay premios registrados a√∫n</p>
          <p style="margin-top: 10px; font-size: 14px">
            Haz clic en "Nuevo Premio" para agregar uno
          </p>
        </div>
      </div>
    </div>

    <!-- Modal para Crear/Editar Premio -->
    <div id="modal-premio" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modal-title">Nuevo Premio</h2>
          <button class="close-btn" onclick="cerrarModal()">√ó</button>
        </div>

        <div id="modal-error" class="error-message" style="display: none"></div>

        <form id="form-premio" onsubmit="guardarPremio(event)">
          <div class="form-group">
            <label for="nombre">Nombre del Premio *</label>
            <input type="text" id="nombre" required maxlength="100" />
          </div>

          <div class="form-group">
            <label for="descripcion">Descripci√≥n</label>
            <textarea id="descripcion" maxlength="500"></textarea>
          </div>

          <div class="form-group">
            <label for="cantidad">Cantidad Disponible *</label>
            <input type="number" id="cantidad" required min="0" value="0" />
          </div>

          <div class="form-group">
            <div class="checkbox-group">
              <input type="checkbox" id="activo" checked />
              <label for="activo" style="margin: 0">Premio Activo</label>
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn" onclick="cerrarModal()">
              Cancelar
            </button>
            <button type="submit" class="btn btn-success">Guardar</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      let premios = [];
      let premioEditando = null;

      // Cargar premios al iniciar
      document.addEventListener("DOMContentLoaded", () => {
        cargarPremios();

        // B√∫squeda en tiempo real
        document
          .getElementById("search")
          .addEventListener("input", filtrarPremios);
      });

      async function cargarPremios() {
        try {
          const response = await fetch("/api/premios");
          const data = await response.json();

          if (data.success) {
            premios = data.premios;
            renderizarPremios(premios);
          }
        } catch (error) {
          console.error("Error al cargar premios:", error);
          mostrarError("Error al cargar los premios");
        }
      }

      function renderizarPremios(premiosData) {
        const loading = document.getElementById("loading");
        const table = document.getElementById("premios-table");
        const emptyState = document.getElementById("empty-state");
        const tbody = document.getElementById("premios-tbody");

        loading.style.display = "none";

        if (premiosData.length === 0) {
          table.style.display = "none";
          emptyState.style.display = "block";
          return;
        }

        table.style.display = "table";
        emptyState.style.display = "none";

        tbody.innerHTML = premiosData
          .map(
            (premio) => `
                <tr>
                    <td>${premio.id}</td>
                    <td><strong>${premio.nombre}</strong></td>
                    <td>${premio.descripcion || "-"}</td>
                    <td>${premio.cantidad_disponible}</td>
                    <td>
                        ${
                          premio.cantidad_disponible === 0
                            ? '<span class="badge badge-inactive">Sin stock</span>'
                            : premio.activo
                            ? '<span class="badge badge-success">‚úì Activo</span>'
                            : '<span class="badge badge-inactive">‚úó Inactivo</span>'
                        }
                    </td>
                    <td>${new Date(premio.fecha_creacion).toLocaleDateString(
                      "es-CO"
                    )}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn btn-edit" onclick="abrirModalEditar(${
                              premio.id
                            })">‚úèÔ∏è Editar</button>
                            <button class="action-btn btn-delete" onclick="eliminarPremio(${
                              premio.id
                            })">üóëÔ∏è Eliminar</button>
                        </div>
                    </td>
                </tr>
            `
          )
          .join("");
      }

      function filtrarPremios() {
        const searchTerm = document
          .getElementById("search")
          .value.toLowerCase();

        const premiosFiltrados = premios.filter((premio) => {
          return (
            premio.nombre.toLowerCase().includes(searchTerm) ||
            (premio.descripcion &&
              premio.descripcion.toLowerCase().includes(searchTerm))
          );
        });

        renderizarPremios(premiosFiltrados);
      }

      function abrirModalCrear() {
        premioEditando = null;
        document.getElementById("modal-title").textContent = "Nuevo Premio";
        document.getElementById("form-premio").reset();
        document.getElementById("activo").checked = true;
        document.getElementById("modal-error").style.display = "none";
        document.getElementById("modal-premio").classList.add("active");
      }

      function abrirModalEditar(id) {
        const premio = premios.find((p) => p.id === id);
        if (!premio) return;

        premioEditando = premio;
        document.getElementById("modal-title").textContent = "Editar Premio";
        document.getElementById("nombre").value = premio.nombre;
        document.getElementById("descripcion").value = premio.descripcion || "";
        document.getElementById("cantidad").value = premio.cantidad_disponible;
        document.getElementById("activo").checked = premio.activo;
        document.getElementById("modal-error").style.display = "none";
        document.getElementById("modal-premio").classList.add("active");
      }

      function cerrarModal() {
        document.getElementById("modal-premio").classList.remove("active");
        premioEditando = null;
      }

      // L√≥gica del Modal de Confirmaci√≥n
      let confirmCallback = null;

      function showConfirmModal(title, message, callback) {
        document.getElementById("confirm-title").textContent = title;
        document.getElementById("confirm-message").textContent = message;
        confirmCallback = callback;
        document.getElementById("confirm-modal").classList.add("active");
      }

      function closeConfirmModal() {
        document.getElementById("confirm-modal").classList.remove("active");
        confirmCallback = null;
      }

      document
        .getElementById("confirm-btn-action")
        .addEventListener("click", () => {
          if (confirmCallback) confirmCallback();
          closeConfirmModal();
        });

      async function guardarPremio(event) {
        event.preventDefault();

        const data = {
          nombre: document.getElementById("nombre").value.trim(),
          descripcion: document.getElementById("descripcion").value.trim(),
          cantidad_disponible: parseInt(
            document.getElementById("cantidad").value
          ),
          activo: document.getElementById("activo").checked,
        };

        try {
          let response;
          if (premioEditando) {
            // Actualizar
            response = await fetch(`/api/premio/${premioEditando.id}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });
          } else {
            // Crear
            response = await fetch("/api/premio", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });
          }

          const result = await response.json();

          if (result.success) {
            cerrarModal();
            cargarPremios();
            const nombrePremio = document.getElementById("nombre").value.trim();
            if (premioEditando) {
              showToast(`‚úÖ Premio actualizado: ${nombrePremio}`, "success");
              showUpdateSuccessModal(nombrePremio);
            } else {
              showToast(`‚úÖ Premio creado: ${nombrePremio}`, "success");
            }
          } else {
            mostrarErrorModal(result.message);
          }
        } catch (error) {
          console.error("Error al guardar premio:", error);
          mostrarErrorModal("Error al guardar el premio");
        }
      }

      function showUpdateSuccessModal(nombre) {
        const modal = document.getElementById("update-success-modal");
        const text = document.getElementById("update-success-text");
        text.textContent = `El premio "${nombre}" fue actualizado correctamente.`;
        modal.classList.add("active");
      }

      async function eliminarPremio(id) {
        const premio = premios.find((p) => p.id === id);
        if (!premio) return;

        showConfirmModal(
          "¬øEliminar Premio?",
          `¬øEst√°s seguro de eliminar "${premio.nombre}"? Esta acci√≥n no es reversible.`,
          async () => {
            try {
              const response = await fetch(`/api/premio/${id}`, {
                method: "DELETE",
              });
              const result = await response.json();

              if (result.success) {
                cargarPremios();
                showToast(result.message, "success");
              } else {
                showToast(result.message, "error");
              }
            } catch (error) {
              console.error("Error al eliminar premio:", error);
              showToast("Error al eliminar el premio", "error");
            }
          }
        );
      }

      function mostrarErrorModal(mensaje) {
        const errorDiv = document.getElementById("modal-error");
        errorDiv.textContent = mensaje;
        errorDiv.style.display = "block";
      }

      function mostrarError(mensaje) {
        showToast(mensaje, "error");
      }

      // Cerrar modal al hacer clic fuera
      document.getElementById("modal-premio").addEventListener("click", (e) => {
        if (e.target.id === "modal-premio") {
          cerrarModal();
        }
      });

      document
        .getElementById("update-success-modal")
        .addEventListener("click", (e) => {
          if (e.target.id === "update-success-modal") {
            e.currentTarget.classList.remove("active");
          }
        });
      document
        .getElementById("update-success-close")
        .addEventListener("click", () => {
          document
            .getElementById("update-success-modal")
            .classList.remove("active");
        });

      async function cerrarSesion() {
        showConfirmModal(
          "Cerrar Sesi√≥n",
          "¬øEst√°s seguro de que quieres salir del sistema?",
          async () => {
            try {
              const response = await fetch("/api/logout", { method: "POST" });
              const data = await response.json();
              if (data.success) window.location.href = "/";
            } catch (error) {
              console.error("Error al cerrar sesi√≥n:", error);
              window.location.href = "/";
            }
          }
        );
      }

      function showToast(message, type) {
        let container = document.getElementById("toast-container");
        if (!container) {
          container = document.createElement("div");
          container.id = "toast-container";
          container.className = "toast-container";
          document.body.appendChild(container);
        }
        const t = document.createElement("div");
        t.className = "toast " + (type ? "toast-" + type : "toast-info");
        t.textContent = String(message || "");
        container.appendChild(t);
        requestAnimationFrame(() => {
          t.classList.add("visible");
        });
        setTimeout(() => {
          t.classList.remove("visible");
          setTimeout(() => {
            if (t.parentNode) t.parentNode.removeChild(t);
          }, 250);
        }, 3500);
      }
    </script>

    <!-- Modal de Confirmaci√≥n -->
    <div id="confirm-modal" class="modal-overlay">
      <div class="modal-content" style="max-width: 400px; text-align: center">
        <div style="font-size: 48px; margin-bottom: 16px">‚ö†Ô∏è</div>
        <h3
          id="confirm-title"
          style="margin: 0 0 10px 0; color: #0f172a; font-size: 22px"
        >
          Confirmaci√≥n
        </h3>
        <p
          id="confirm-message"
          style="color: #64748b; margin-bottom: 24px; line-height: 1.5"
        ></p>
        <div style="display: flex; gap: 12px; justify-content: center">
          <button
            class="btn"
            onclick="closeConfirmModal()"
            style="
              background: #f1f5f9;
              color: #475569;
              border: none;
              padding: 10px 20px;
              border-radius: 10px;
              cursor: pointer;
              font-weight: 600;
            "
          >
            Cancelar
          </button>
          <button
            id="confirm-btn-action"
            style="
              background: #ef4444;
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 10px;
              cursor: pointer;
              font-weight: 600;
              box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);
            "
          >
            Confirmar
          </button>
        </div>
      </div>
    </div>

    <!-- Modal de Actualizaci√≥n Exitosa -->
    <div id="update-success-modal" class="modal-overlay">
      <div class="modal-content" style="max-width: 420px; text-align: center">
        <div style="font-size: 48px; margin-bottom: 14px">‚úÖ</div>
        <h3 style="margin: 0 0 10px 0; color: #0f172a; font-size: 22px">
          Premio Actualizado
        </h3>
        <p
          id="update-success-text"
          style="color: #64748b; margin-bottom: 20px; line-height: 1.6"
        >
          Actualizaci√≥n realizada correctamente.
        </p>
        <div class="modal-actions" style="justify-content: center">
          <button id="update-success-close" class="btn btn-primary">
            Aceptar
          </button>
        </div>
      </div>
    </div>
  </body>
</html>
